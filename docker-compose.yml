services:
  vpn-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hedge-vpn-sync
    image: hedge-vpn-sync:latest
    privileged: true
    volumes:
      - type: bind
        source: ${VPN_BASE_PATH:-/mnt/pareto}
        target: /mnt/pareto
        read_only: true
        bind:
          propagation: rshared
      - ${HOST_OPENVPN_DIR:-/etc/openvpn}:/etc/openvpn:ro
      - ${HOST_SMB_CREDENTIALS_FILE:-/root/.smbcredentials}:/root/.smbcredentials:ro
      - ${HOST_GCP_CREDENTIALS_FILE:-./credentials.json}:/app/credentials.json:ro
    environment:
      - VPN_BASE_PATH=${VPN_BASE_PATH:-/mnt/pareto}
      
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - GCS_TEMP_BUCKET=${GCS_TEMP_BUCKET}
      
      - BIGQUERY_DATASET_ID=${BIGQUERY_DATASET_ID}
      - BIGQUERY_TABLE_ID=${BIGQUERY_TABLE_ID}
      - BIGQUERY_LOG_TABLE_ID=${BIGQUERY_LOG_TABLE_ID}
      
      - SYNC_BATCH_SIZE=${SYNC_BATCH_SIZE:-100}
      - SYNC_USE_JSONL_THRESHOLD=${SYNC_USE_JSONL_THRESHOLD:-1000}
      - SYNC_PROGRESS_INTERVAL=${SYNC_PROGRESS_INTERVAL:-100}
      
      - UPLOAD_RETRY_ATTEMPTS=${UPLOAD_RETRY_ATTEMPTS:-3}
      - UPLOAD_RETRY_DELAY=${UPLOAD_RETRY_DELAY:-1.0}
      
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/credentials.json}
    command: ["sleep", "infinity"]
    restart: unless-stopped
    networks:
      - vpn-sync-network

networks:
  vpn-sync-network:
    driver: bridge

