name: Deploy Hedge VPN Sync to GCE

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PROJECT_ID: pareto-engine-n8n
  VM_NAME: hedge-vpn-sync-vm
  VM_ZONE: us-central1-a
  REPO_URL: https://github.com/paretogroup/hedge-vpn-sync.git

jobs:
  deploy:
    name: Deploy to GCE
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Set up Cloud SDK'
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 'Deploy to VM'
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.VM_ZONE }} \
            --command="
              set -euo pipefail

              export GH_PAT='${{ secrets.GH_PAT }}'
              export REPO_URL='${{ env.REPO_URL }}'

              WORKDIR=/opt/hedge-vpn-sync

              sudo mkdir -p \"\$WORKDIR\"
              sudo chown -R \$USER:\$USER \"\$WORKDIR\"

              git config --global credential.helper store
              git config --global url.\"https://\"\$GH_PAT\"@github.com/\".insteadOf 'https://github.com/'

              if [ -d \"\$WORKDIR/.git\" ]; then
                cd \"\$WORKDIR\"
                if git remote get-url origin >/dev/null 2>&1; then
                  git remote set-url origin \"\$REPO_URL\"
                fi
                git fetch origin
                git checkout master || git checkout -b master
                git reset --hard origin/master
                git clean -fd
              else
                git clone \"\$REPO_URL\" \"\$WORKDIR\"
                cd \"\$WORKDIR\"
                git checkout master || true
              fi

              if [ ! -f 'docker-compose.yml' ]; then
                echo 'ERROR: docker-compose.yml not found in /opt/hedge-vpn-sync'
                exit 1
              fi

              docker compose down --timeout 30 || true
              docker builder prune -af || true
              docker image prune -af || true
              docker volume prune -f || true

              docker compose build --pull

              SERVICE_SRC=\"\$WORKDIR/systemd/hedge-vpn-mount.service\"
              SERVICE_DEST=\"/etc/systemd/system/hedge-vpn-mount.service\"

              if [ -f \"\$WORKDIR/scripts/vpn_mount.sh\" ] && [ -f \"\$SERVICE_SRC\" ]; then
                chmod +x \"\$WORKDIR/scripts/vpn_mount.sh\"
                sudo install -m 0644 \"\$SERVICE_SRC\" \"\$SERVICE_DEST\"
                sudo systemctl daemon-reload
                sudo systemctl enable hedge-vpn-mount.service
                sudo systemctl restart hedge-vpn-mount.service

                echo \"Waiting for VPN mount service...\"
                for attempt in {1..12}; do
                  if sudo mountpoint -q /mnt/pareto; then
                    echo \"VPN mount is active.\"
                    break
                  fi
                  sleep 5
                  if [ \"\$attempt\" -eq 12 ]; then
                    echo \"Warning: VPN mount not ready after 60s. Check journalctl -u hedge-vpn-mount.service.\"
                  fi
                done
              else
                echo \"Warning: vpn_mount.sh or systemd unit file missing in repo.\"
              fi

              MAIN_CRON='0 */3 * * * cd /opt/hedge-vpn-sync && /usr/bin/docker compose run --rm vpn-sync python main.py >> /var/log/vpn-sync-cron.log 2>&1'
              VPN_CRON='*/5 * * * * if ! pgrep -f vpn_mount.sh > /dev/null; then nohup /opt/hedge-vpn-sync/scripts/vpn_mount.sh > /var/log/vpn_mount.log 2>&1 & fi'

              TEMP_ROOT_CRON=\$(mktemp)
              sudo crontab -u root -l 2>/dev/null | grep -v 'vpn-sync.*main.py' | grep -v 'vpn_mount.sh' > \"\$TEMP_ROOT_CRON\" || true
              echo \"\$MAIN_CRON\" >> \"\$TEMP_ROOT_CRON\"
              echo \"\$VPN_CRON\" >> \"\$TEMP_ROOT_CRON\"
              sudo crontab -u root \"\$TEMP_ROOT_CRON\"
              rm \"\$TEMP_ROOT_CRON\"
            "

      - name: 'Restart VM'
        run: |
          gcloud compute instances reset ${{ env.VM_NAME }} \
            --zone=${{ env.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }}

