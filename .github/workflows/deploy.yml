name: Deploy Hedge VPN Sync to GCE

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PROJECT_ID: pareto-engine-n8n
  VM_NAME: hedge-vpn-sync-vm
  VM_ZONE: us-central1-a
  REPO_URL: https://github.com/paretogroup/hedge-vpn-sync.git

jobs:
  deploy:
    name: Deploy to GCE
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Set up Cloud SDK'
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 'Deploy to VM'
        run: |
          # Execute deployment directly on VM
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.VM_ZONE }} \
            --command="
              export GH_PAT='${{ secrets.GH_PAT }}'
              export REPO_URL='${{ env.REPO_URL }}'
              export COMMIT_SHA='${{ github.sha }}'
              
              sudo mkdir -p /opt/hedge-vpn-sync
              sudo chown -R \$USER:\$USER /opt/hedge-vpn-sync
              cd /opt/hedge-vpn-sync
              
              git config --global credential.helper store
              git config --global url.'https://'\$GH_PAT'@github.com/'.insteadOf 'https://github.com/'
              git config --global --list | grep credential || echo 'No credential config found'
              git config --global --list | grep url || echo 'No URL rewrite config found'
              
              if [ -d '.git' ]; then
                echo 'Repository exists, updating...'
                git branch -v || true
                git log --oneline -1 || true
                git remote -v || true
                
                CURRENT_URL=\$(git remote get-url origin 2>/dev/null || echo '')
                if [[ \$CURRENT_URL == git@github.com:* ]]; then
                  git remote set-url origin \$REPO_URL
                  git remote -v
                fi
                
                git fetch origin || echo 'Fetch failed, trying to reset...'
                git checkout master || git checkout -b master
                git reset --hard origin/master || echo 'Reset failed'
                git clean -fd || true
                git branch -v || true
                git log --oneline -1 || true
              else
                echo 'Repository does not exist, cloning...'
                git clone \$REPO_URL . || { echo 'Clone failed!'; exit 1; }
                cd /opt/hedge-vpn-sync
                git checkout master || echo 'Checkout master failed'
                git remote -v
              fi
              
              sudo chown -R \$USER:\$USER /opt/hedge-vpn-sync
              
              cd /opt/hedge-vpn-sync
              pwd
              ls -la
              
              if [ ! -f 'docker-compose.yml' ]; then
                echo 'ERROR: docker-compose.yml not found in /opt/hedge-vpn-sync'
                exit 1
              fi
              
              echo 'Stopping existing containers...'
              docker compose down --timeout 30 || true
              
              echo 'Building containers...'
              docker compose build --no-cache || { echo 'Build failed!'; exit 1; }
              
              echo 'Starting containers...'
              docker compose up -d || { echo 'Start failed!'; exit 1; }
              
              sleep 10
              if docker compose ps | grep -q 'Up'; then
                echo 'Deployment successful!'
                docker compose ps
              else
                echo 'Deployment failed!'
                docker compose ps
                docker compose logs --tail=50
                exit 1
              fi
              
              echo 'Activating network (VPN mount)...'
              if [ -f /opt/hedge-vpn-sync/scripts/vpn_mount.sh ]; then
                chmod +x /opt/hedge-vpn-sync/scripts/vpn_mount.sh
                if ! pgrep -f 'vpn_mount.sh' > /dev/null; then
                  nohup sudo /opt/hedge-vpn-sync/scripts/vpn_mount.sh > /var/log/vpn_mount.log 2>&1 &
                  echo 'VPN mount script started in background'
                  sleep 5
                  if pgrep -f 'vpn_mount.sh' > /dev/null; then
                    echo 'Network activated successfully!'
                  else
                    echo 'Warning: VPN mount script may have failed. Check /var/log/vpn_mount.log'
                  fi
                else
                  echo 'VPN mount script is already running'
                fi
              else
                echo 'Warning: vpn_mount.sh not found in /opt/hedge-vpn-sync/scripts/'
              fi
              
              echo 'Setting up cron jobs...'
              
              # Cron job para verificar e reiniciar vpn_mount.sh se necessário (no crontab do root)
              VPN_MOUNT_CRON='*/5 * * * * if ! pgrep -f vpn_mount.sh > /dev/null; then nohup /opt/hedge-vpn-sync/scripts/vpn_mount.sh > /var/log/vpn_mount.log 2>&1 & fi'
              
              # Configurar cron job do vpn_mount.sh no crontab do root
              TEMP_ROOT_CRON=\$(mktemp)
              sudo crontab -l 2>/dev/null | grep -v 'vpn_mount.sh' > \"\$TEMP_ROOT_CRON\" || true
              echo \"\$VPN_MOUNT_CRON\" >> \"\$TEMP_ROOT_CRON\"
              sudo crontab \"\$TEMP_ROOT_CRON\"
              rm \"\$TEMP_ROOT_CRON\"
              echo 'VPN mount monitor cron job configured (runs every 5 minutes as root)'
              
              # Cron job para main.py (executa a cada hora no crontab do usuário)
              MAIN_CRON='0 * * * * cd /opt/hedge-vpn-sync && docker compose run --rm vpn-sync python main.py >> /var/log/vpn-sync-cron.log 2>&1'
              
              # Configurar cron job do main.py no crontab do usuário
              TEMP_USER_CRON=\$(mktemp)
              crontab -l 2>/dev/null | grep -v 'vpn-sync.*main.py' > \"\$TEMP_USER_CRON\" || true
              echo \"\$MAIN_CRON\" >> \"\$TEMP_USER_CRON\"
              crontab \"\$TEMP_USER_CRON\"
              rm \"\$TEMP_USER_CRON\"
              echo 'Main sync cron job configured (runs every hour)'
              
              echo 'All cron jobs configured successfully!'
              echo 'Verifying cron jobs...'
              echo 'Root crontab (vpn_mount.sh):'
              sudo crontab -l | grep 'vpn_mount' || echo '  (none found)'
              echo 'User crontab (main.py):'
              crontab -l | grep 'vpn-sync.*main.py' || echo '  (none found)'
            "

